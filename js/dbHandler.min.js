var db,results=[];window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB;function dbConn(){let b=window.indexedDB.open("tmTimerDB",1);b.onerror=function(c){console.log("Database error code: "+c.target.errorCode)},b.onsuccess=function(){if(db=b.result,isNewMeeting())clearTimetable();else{let d=db.transaction(["timeTable"],"readonly").objectStore("timeTable").count();d.onsuccess=function(){0===d.result&&restoreData()}}},b.onupgradeneeded=function(c){var d=c.currentTarget.result.createObjectStore("timeTable",{keyPath:"id",autoIncrement:!0});d.createIndex("member","member",{unique:!1}),d.createIndex("role","role",{unique:!1}),d.createIndex("min","min",{unique:!1}),d.createIndex("opt","opt",{unique:!1}),d.createIndex("max","max",{unique:!1}),d.createIndex("time","time",{unique:!1}),d.createIndex("lastColor","lastColor",{unique:!1}),d.createIndex("disqualified","disqualified",{unique:!1})}}function initializeDB(b,c){if(c!==b)try{window.indexedDB.deleteDatabase("tmTimerDB")}catch(d){}dbConn()}function deleteByIDs(b){let c=db.transaction(["timeTable"],"readwrite");for(i=0;i<b.length;i++)c.objectStore("timeTable").delete(b[i]),$(`#tr${b[i]}`).hide();return saveData(),c.objectStore("timeTable").count()}function clearTimetable(){db.transaction(["timeTable"],"readwrite").objectStore("timeTable").clear(),saveData()}function isNewMeeting(){let b=new Date().toString("yyyy/MM/dd");return null===localStorage.getItem("meetingDate")?(localStorage.setItem("meetingDate",b),!0):localStorage.getItem("meetingDate")!==b&&(localStorage.removeItem("meetingDate"),localStorage.setItem("meetingDate",b),!0)}function addNewTime(b,c,d,f,g,h,j,k){db.transaction(["timeTable"],"readwrite").objectStore("timeTable").add({member:b,role:c,min:d,opt:f,max:g,time:h,lastColor:j,disqualified:k}),saveData()}function restoreData(){new Date().toString("yyyy/MM/dd")===localStorage.getItem("backUpDate")&&$.each(JSON.parse("["+localStorage.getItem("backUpTT")+"]"),function(b,c){addNewTime(c.member,c.role,c.min,c.opt,c.max,c.time,c.lastColor,c.disqualified)})}function saveData(){let b=db.transaction(["timeTable"],"readwrite").objectStore("timeTable").openCursor();var c=[];b.onsuccess=function(d){let f=d.target.result;f?(c.push(JSON.stringify(f.value)),f.continue()):(setLocalStorage("backUpDate",new Date().toString("yyyy/MM/dd")),setLocalStorage("backUpTT",c))}}function countTimetable(){let b=db.transaction(["timeTable"],"readonly").objectStore("timeTable").count();b.onsuccess=function(){0<b.result?($("#hNoResults").hide(),$("#tblResults,#btnMultiple,#btnDelete,#linkDownload,#btnShare").show()):($("#hNoResults").show(),$("#tblResults,#btnDelete,#btnMultiple,#linkDownload,#btnShare").hide())}}function getSeconds(b){var c=b.split(":");return 60*(60*+c[0])+60*+c[1]+ +c[2]}function printTable(){$("#tBodyResults").empty(),results=[];let b=db.transaction(["timeTable"],"readwrite").objectStore("timeTable").openCursor();b.onsuccess=function(c){let d=c.target.result;if(d){let h="white";("yellow"===d.value.lastColor||"black"===d.value.lastColor||"white"===d.value.lastColor)&&(h="black");let j=d.value.lastColor;"black"===j&&(j="white");var f=getSeconds(d.value.time),g=getSeconds(d.value.min);g-30<=f&&f<g&&(j="#CCFFCC",h="black"),d.value.disqualified&&(j="black",h="white"),results.push({member:d.value.member,role:d.value.role,min:d.value.min,opt:d.value.opt,max:d.value.max,time:d.value.time,lastColor:d.value.lastColor,disqualified:d.value.disqualified}),$("#tBodyResults").append(`<tr id="tr${d.value.id}" style="background:${j};color:${h}"><td class="tdDel" style="display:none"><input id="chk${d.value.id}" class="chkDel" type="checkbox" /></td><td>${d.value.member}</td><td>${d.value.role}</td><td style="text-align:center">${d.value.time}</td></tr>`),d.continue()}else $("#divResults").modal().on("shown.bs.modal",function(h){resizeModal(),h.stopPropagation()})}}